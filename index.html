<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة الديون المتأخرة - SOA Overdue Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #45a049;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .loading-ring {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        th, td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #1f2937;
        }
        .dr { color: #ef4444; font-weight: 600; } /* Debit */
        .cr { color: #10b981; font-weight: 600; } /* Credit */

        /* Custom file input styling */
        .custom-file-upload {
            border: 2px dashed #9ca3af;
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-file-upload:hover {
            border-color: #4CAF50;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">حاسبة الديون المتأخرة</h1>
            <p class="text-lg text-gray-600">تحليل فواتير كشف حساب (SOA) من ملفات PDF باستخدام Gemini AI</p>
        </header>

        <!-- Main Card: Upload & Results -->
        <div class="card p-6 sm:p-10 rounded-xl">
            <h2 class="text-2xl font-bold mb-6 text-gray-700 border-b pb-3">تحليل ملفات SOA</h2>

            <!-- File Upload Section -->
            <div class="mb-8">
                <label for="pdf-upload" class="block text-gray-700 font-medium mb-3">
                    قم برفع ملفات PDF الخاصة بكشوف الحساب (SOA)
                </label>
                <div class="custom-file-upload p-6 rounded-lg text-center">
                    <p class="text-gray-500 mb-2">اضغط هنا لرفع الملف أو اسحب الملف وأفلته</p>
                    <input type="file" id="pdf-upload" multiple accept="application/pdf" class="hidden" onchange="handleFileUpload(event)">
                    <label for="pdf-upload" class="inline-block px-6 py-2 rounded-lg btn-primary cursor-pointer text-sm font-semibold">
                        اختيار ملفات PDF
                    </label>
                </div>
                <div id="file-list" class="mt-4 text-sm text-gray-600 space-y-1"></div>
            </div>

            <!-- Analysis Button -->
            <div class="flex justify-center mb-8">
                <button id="analyze-btn" class="flex items-center justify-center px-8 py-3 rounded-xl text-lg font-bold btn-primary disabled:opacity-50" onclick="startAnalysis()" disabled>
                    بدء التحليل
                    <div id="loading-spinner" class="loading-ring hidden"></div>
                </button>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700">نتائج التحليل الإجمالية</h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <p class="text-sm text-blue-600 font-medium">إجمالي الديون (Dr.)</p>
                        <p id="total-dr" class="text-2xl font-bold text-blue-800 mt-1">0.00</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <p class="text-sm text-red-600 font-medium">إجمالي المستحقات (Cr.)</p>
                        <p id="total-cr" class="text-2xl font-bold text-red-800 mt-1">0.00</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg text-center">
                        <p class="text-sm text-orange-600 font-medium">الصافي المستحق</p>
                        <p id="net-total" class="text-2xl font-bold text-orange-800 mt-1">0.00</p>
                    </div>
                </div>

                <!-- AI-Powered Actions -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-150" onclick="generateAnalysis()">
                        ✨ ملخص التحليل المالي
                        <div id="summary-loading" class="loading-ring hidden"></div>
                    </button>
                    <button class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center transition duration-150" onclick="generateCollectionNotice()">
                        ✨ صياغة إشعار المطالبة
                        <div id="notice-loading" class="loading-ring hidden"></div>
                    </button>
                </div>

                <!-- AI Output Display -->
                <div id="ai-output" class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200 hidden">
                    <h4 id="ai-output-title" class="text-lg font-bold mb-3 text-gray-700 border-b pb-2"></h4>
                    <div id="ai-output-content" class="whitespace-pre-wrap text-gray-700 leading-relaxed"></div>
                    <button id="copy-ai-output" class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-3 rounded-lg text-sm transition duration-150 hidden" onclick="copyToClipboard(document.getElementById('ai-output-content').textContent)">
                        نسخ النص
                    </button>
                </div>


                <h4 class="text-lg font-bold mb-3 text-gray-700">تفاصيل الفواتير المستخلصة</h4>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-3 px-6 text-xs font-medium uppercase tracking-wider text-gray-700">التاريخ</th>
                                <th class="py-3 px-6 text-xs font-medium uppercase tracking-wider text-gray-700">الرقم المرجعي</th>
                                <th class="py-3 px-6 text-xs font-medium uppercase tracking-wider text-gray-700">المبلغ المستحق</th>
                                <th class="py-3 px-6 text-xs font-medium uppercase tracking-wider text-gray-700">تاريخ الاستحقاق</th>
                                <th class="py-3 px-6 text-xs font-medium uppercase tracking-wider text-gray-700">أيام التأخير</th>
                            </tr>
                        </thead>
                        <tbody id="bills-table-body" class="divide-y divide-gray-100">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Error/Message Box -->
            <div id="message-box" class="mt-8 p-4 rounded-lg border hidden" role="alert">
                <p id="message-text" class="font-medium"></p>
            </div>
        </div>

        <!-- Hidden Global Variables Setup -->
        <script>
            // Global variables provided by the Canvas environment
            const apiKey = "";
        </script>

    </div>

    <!-- Main Application Script -->
    <script>
        let uploadedFiles = [];
        let extractedData = null; // Store extracted JSON data globally
        const analyzeBtn = document.getElementById('analyze-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const summaryLoading = document.getElementById('summary-loading');
        const noticeLoading = document.getElementById('notice-loading');
        const fileListDiv = document.getElementById('file-list');
        const resultsSection = document.getElementById('results-section');
        const billsTableBody = document.getElementById('bills-table-body');
        const totalDrEl = document.getElementById('total-dr');
        const totalCrEl = document.getElementById('total-cr');
        const netTotalEl = document.getElementById('net-total');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const aiOutputDiv = document.getElementById('ai-output');
        const aiOutputTitle = document.getElementById('ai-output-title');
        const aiOutputContent = document.getElementById('ai-output-content');
        const copyAiOutputBtn = document.getElementById('copy-ai-output');
        
        // Base API URL for Gemini
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // --- Utility Functions ---

        /**
         * Clears all messages from the message box.
         */
        function clearMessage() {
            messageBox.classList.add('hidden');
            messageText.textContent = '';
            messageBox.className = 'mt-8 p-4 rounded-lg border hidden'; // Reset classes
        }

        /**
         * Displays a message (success, error, or info).
         * @param {string} text - The message text.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function displayMessage(text, type) {
            clearMessage();
            messageText.textContent = text;
            messageBox.classList.remove('hidden');

            switch (type) {
                case 'error':
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    break;
                case 'success':
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    break;
            }
        }

        /**
         * Converts a File object to a base64 encoded string for the API.
         * @param {File} file - The PDF file object.
         * @returns {Promise<string>} - Base64 string of the file data.
         */
        function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type,
                        },
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Attempts to fix common JSON truncation errors from the API response.
         * @param {string} jsonString - The potentially broken JSON string.
         * @returns {string} - The fixed JSON string.
         */
        function fixTruncatedJson(jsonString) {
            // Trim whitespace and remove trailing commas/brackets/braces if present
            let fixed = jsonString.trim();
            
            // If it ends with a comma (due to array truncation)
            if (fixed.endsWith(',')) {
                fixed = fixed.slice(0, -1);
            }

            // Simple closure attempts (assuming the start is always correct)
            if (!fixed.endsWith('}')) {
                // If it looks like a bill object was being built
                if (fixed.match(/"overdue_days"\s*:\s*\d+$/)) {
                    fixed += '}' // close the bill object
                }
            }
            // Close the bills array and the main object if needed
            if (!fixed.endsWith(']')) {
                 if (fixed.endsWith('}')) {
                     fixed += ']' // close the bills array
                 }
            }
             if (!fixed.endsWith('}')) {
                 if (fixed.endsWith(']')) {
                     fixed += '}' // close the main object
                 }
            }
            return fixed;
        }

        /**
         * Copies text to the clipboard.
         * @param {string} text - The text to copy.
         */
        function copyToClipboard(text) {
            try {
                // Use a temporary textarea to hold and select the text
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                displayMessage('تم نسخ النص إلى الحافظة بنجاح!', 'success');
            } catch (err) {
                console.error('Could not copy text: ', err);
                displayMessage('فشل النسخ إلى الحافظة.', 'error');
            }
        }


        // --- Core Application Logic ---

        /**
         * Handles the file input change event.
         * @param {Event} event - The file input event.
         */
        function handleFileUpload(event) {
            uploadedFiles = Array.from(event.target.files).filter(file => file.type === 'application/pdf');
            
            fileListDiv.innerHTML = '';
            if (uploadedFiles.length > 0) {
                uploadedFiles.forEach(file => {
                    fileListDiv.innerHTML += `<p class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L15.586 6A2 2 0 0117 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0-3a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>${file.name}</p>`;
                });
                analyzeBtn.disabled = false;
                clearMessage();
            } else {
                analyzeBtn.disabled = true;
                fileListDiv.innerHTML = '<p class="text-red-500">من فضلك ارفع ملفات بصيغة PDF فقط.</p>';
            }
        }

        /**
         * Starts the analysis process by calling the Gemini API.
         */
        async function startAnalysis() {
            if (uploadedFiles.length === 0) {
                displayMessage('من فضلك ارفع ملفات PDF أولاً.', 'error');
                return;
            }

            // UI updates for loading state
            analyzeBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            clearMessage();
            // IMPROVED: More descriptive loading message, noting potential delay.
            displayMessage('جارٍ تحليل الملفات... قد تستغرق العملية وقتاً أطول لمعالجة ملفات PDF. (جاري المحاولة ' + uploadedFiles.length + ' ملف/ملفات)', 'info');
            resultsSection.classList.add('hidden');
            aiOutputDiv.classList.add('hidden');
            billsTableBody.innerHTML = '';
            extractedData = null; // Reset previous data


            try {
                // 1. Convert all PDF files to a list of Generative Parts
                const pdfParts = await Promise.all(uploadedFiles.map(fileToGenerativePart));

                // 2. Define the system instruction (Role and task constraints)
                const systemPrompt = "You are an expert financial data extraction and analysis tool for Statement of Accounts (SOA) documents. Your task is to process the uploaded PDF images/text, extract ALL individual pending bill details (Date, Ref. No., Pending Amount, Due on, Overdue by days), and provide the output as a clean, complete JSON array that strictly follows the provided schema. ONLY include the bills that have a value in the 'Pending Amount' column (exclude total/summary lines). If a bill is a Credit (Cr.), the amount should be a negative number. Be extremely precise in reading the numbers and dates.";
                
                // 3. Define the desired structured output (JSON Schema)
                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        "summary": {
                            "type": "OBJECT",
                            "description": "Summary of all extracted data.",
                            "properties": {
                                "total_dr": { "type": "NUMBER", "description": "Total Debit (Dr) amount from all bills." },
                                "total_cr": { "type": "NUMBER", "description": "Total Credit (Cr) amount from all bills." },
                            }
                        },
                        "bills": {
                            "type": "ARRAY",
                            "description": "A list of all extracted pending bills.",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "date": { "type": "STRING", "description": "Bill Date (e.g., '10-Apr-25'). Use the exact format found in the PDF." },
                                    "ref_no": { "type": "STRING", "description": "Reference Number (e.g., 'SI-25-D0567')." },
                                    "amount": { "type": "NUMBER", "description": "Pending Amount. Must be negative if 'Cr' (Credit) and positive if 'Dr' (Debit). No currency sign. Use the raw numeric value." },
                                    "due_on": { "type": "STRING", "description": "Due Date (e.g., '9-Jul-25'). Use the exact format found in the PDF." },
                                    "overdue_days": { "type": "NUMBER", "description": "Number of Overdue days. 0 if not overdue. Should be a number." }
                                },
                                "propertyOrdering": ["date", "ref_no", "amount", "due_on", "overdue_days"]
                            }
                        }
                    }
                };
                
                // 4. Construct the full prompt parts (Images + Text instruction)
                const textPrompt = "Extract ALL pending bill details from the uploaded Statement of Account (SOA) PDF images. Format the output strictly as JSON according to the schema. Calculate total Debit and Credit amounts.";
                
                const contents = [
                    ...pdfParts, // All PDF images/data
                    { text: textPrompt } // The text instruction
                ];

                const payload = {
                    contents: contents,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema,
                    }
                };

                // 5. Make the API Call with Retry Logic (Exponential Backoff)
                const MAX_RETRIES = 7; // FIX 2: Increased max retries from 5 to 7
                const DELAY_BASE_MS = 6000; // FIX 1: Increased base delay from 4000ms to 6000ms for long-running PDF analysis.
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break; // Success, exit loop
                    } catch (e) {
                        // Network error, continue to sleep and retry
                        console.error(`Attempt ${i + 1} failed (Network/Fetch Error):`, e);
                    }
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * DELAY_BASE_MS; 
                        console.log(`Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                         // Last retry failed
                         throw new Error('API failed after multiple retries. قد تكون الملفات كبيرة جداً أو هناك مشكلة في اتصال الشبكة.');
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`API response failed: ${response ? response.statusText : 'No response'}`);
                }

                const result = await response.json();
                
                // 6. Extract and Parse the JSON result - **UPDATED PARSING LOGIC**
                let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("لم يتمكن Gemini من استخلاص البيانات. قد تكون جودة الملفات غير واضحة أو تنسيقها غير مدعوم.");
                }
                
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonText);
                } catch (e) {
                    // If initial parse fails, try to fix it (common with truncation on large outputs)
                    displayMessage("تم استرجاع بيانات غير كاملة. جاري محاولة إصلاح التنسيق...", 'info');
                    const fixedJsonText = fixTruncatedJson(jsonText);
                    parsedData = JSON.parse(fixedJsonText);
                }

                extractedData = parsedData; // Store the data
                renderResults(extractedData);


            } catch (error) {
                console.error("Analysis Error:", error);
                // Improved error message for the user
                displayMessage(`حدث خطأ أثناء التحليل: ${error.message || 'خطأ غير معروف.'} برجاء التأكد من جودة الملف أو محاولة رفع ملف أصغر.`, 'error');
            } finally {
                // UI updates for end of processing
                analyzeBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
                
                // Keep the success message visible for a moment
                if (messageText.textContent.includes('جارٍ تحليل')) {
                    displayMessage('تم التحليل بنجاح! يمكنك الآن استخدام أدوات ✨ الذكاء الاصطناعي.', 'success');
                }
            }
        }

        /**
         * Renders the extracted data into the results section.
         * @param {Object} data - The structured JSON data from the API.
         */
        function renderResults(data) {
            resultsSection.classList.remove('hidden');
            billsTableBody.innerHTML = ''; // Clear previous results

            // 1. Handle Summary
            const totalDr = data.summary?.total_dr || 0;
            const totalCr = Math.abs(data.summary?.total_cr || 0); // Display as positive number
            const netTotal = totalDr - totalCr;

            totalDrEl.textContent = `${totalDr.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Dr`;
            totalCrEl.textContent = `${totalCr.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Cr`;
            
            // Apply net total styling (Dr if positive, Cr if negative)
            netTotalEl.textContent = `${Math.abs(netTotal).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${netTotal >= 0 ? 'Dr' : 'Cr'}`;
            netTotalEl.parentElement.classList.remove('bg-green-50', 'bg-red-50', 'bg-orange-100');
            netTotalEl.parentElement.classList.add(netTotal >= 0 ? 'bg-orange-100' : 'bg-green-100');
            netTotalEl.classList.remove('text-green-800', 'text-red-800', 'text-orange-800');
            netTotalEl.classList.add(netTotal >= 0 ? 'text-orange-800' : 'text-green-800');


            // 2. Handle Bills Table
            if (!data.bills || data.bills.length === 0) {
                 billsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">لم يتم استخلاص أي فواتير مستحقة.</td></tr>';
                 return;
            }

            // Sort bills by Overdue Days (descending)
            const sortedBills = data.bills.sort((a, b) => (b.overdue_days || 0) - (a.overdue_days || 0));

            sortedBills.forEach(bill => {
                const isDebit = bill.amount >= 0;
                const amountText = `${Math.abs(bill.amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${isDebit ? 'Dr' : 'Cr'}`;
                const amountClass = isDebit ? 'dr' : 'cr';
                const overdueText = bill.overdue_days && bill.overdue_days > 0 ? bill.overdue_days : '-';

                const row = document.createElement('tr');
                // Highlight row if overdue by a lot
                if (bill.overdue_days && bill.overdue_days > 90) {
                    row.classList.add('bg-red-50');
                } else if (bill.overdue_days && bill.overdue_days > 30) {
                     row.classList.add('bg-yellow-50');
                }


                row.innerHTML = `
                    <td class="text-sm text-gray-800">${bill.date || '-'}</td>
                    <td class="text-sm text-gray-800">${bill.ref_no || '-'}</td>
                    <td class="text-sm ${amountClass}">${amountText}</td>
                    <td class="text-sm text-gray-800">${bill.due_on || '-'}</td>
                    <td class="text-sm text-gray-800 font-bold ${bill.overdue_days && bill.overdue_days > 0 ? 'text-red-600' : ''}">${overdueText}</td>
                `;
                billsTableBody.appendChild(row);
            });
        }
        
        // --- Gemini AI Features ---

        /**
         * Generates a financial summary of the extracted data.
         */
        async function generateAnalysis() {
            if (!extractedData) {
                displayMessage('يرجى تحليل ملف SOA أولاً للحصول على البيانات.', 'info');
                return;
            }
            
            summaryLoading.classList.remove('hidden');
            aiOutputDiv.classList.add('hidden');
            displayMessage('جارٍ إنشاء الملخص المالي بواسطة Gemini...', 'info');

            try {
                // Convert structured data back to a descriptive prompt for the LLM
                const billList = extractedData.bills.map(b => 
                    `(${b.ref_no} - ${Math.abs(b.amount).toFixed(2)} ${b.amount >= 0 ? 'Dr' : 'Cr'} - متأخر ${b.overdue_days} يوم)`
                ).join('; ');
                
                const prompt = `Based on the following extracted financial data:
                1. Total Debit (Dr): ${extractedData.summary.total_dr.toFixed(2)}
                2. Total Credit (Cr): ${Math.abs(extractedData.summary.total_cr).toFixed(2)}
                3. Net Total: ${(extractedData.summary.total_dr + extractedData.summary.total_cr).toFixed(2)}
                4. Pending Bills: ${billList}
                
                Act as a Senior Financial Analyst. Provide a concise, executive summary in Arabic (around 3-4 sentences) that highlights the most critical findings. Focus on:
                - The overall net balance status.
                - Mention the number of invoices overdue by more than 90 days (if any).
                - Identify the largest single outstanding bill reference number and amount.
                `;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "You are a professional financial analyst. Your output must be a concise, formal summary written entirely in Arabic." }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("فشل في الاتصال بـ Gemini.");
                
                const result = await response.json();
                const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (analysisText) {
                    renderAiOutput('ملخص التحليل المالي', analysisText);
                    displayMessage('تم إنشاء الملخص بنجاح.', 'success');
                } else {
                    throw new Error('لم يتم استلام نص الملخص.');
                }

            } catch (error) {
                console.error("AI Analysis Error:", error);
                displayMessage(`حدث خطأ أثناء إنشاء الملخص: ${error.message}`, 'error');
            } finally {
                summaryLoading.classList.add('hidden');
            }
        }

        /**
         * Generates a draft email for debt collection.
         */
        async function generateCollectionNotice() {
             if (!extractedData) {
                displayMessage('يرجى تحليل ملف SOA أولاً للحصول على البيانات.', 'info');
                return;
            }

            noticeLoading.classList.remove('hidden');
            aiOutputDiv.classList.add('hidden');
            displayMessage('جارٍ صياغة إشعار المطالبة بواسطة Gemini...', 'info');

            try {
                const totalNetDr = (extractedData.summary.total_dr + extractedData.summary.total_cr).toFixed(2);
                const largestBill = extractedData.bills.sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount))[0];
                
                // Prepare the list of bills for the prompt
                const billDetails = extractedData.bills.map(b => 
                    `* رقم الفاتورة: ${b.ref_no}, تاريخ الاستحقاق: ${b.due_on}, المبلغ المستحق: ${Math.abs(b.amount).toFixed(2)} ${b.amount >= 0 ? 'Dr' : 'Cr'}, متأخر بـ: ${b.overdue_days} يوم.`
                ).join('\n');


                const prompt = `Draft a professional, yet firm, debt collection email in Arabic. The email should be suitable for a B2B client. Use the following financial details:
                - Net total outstanding amount (Debit only): ${totalNetDr}
                - The largest outstanding bill is Ref. No. ${largestBill.ref_no} for amount ${Math.abs(largestBill.amount).toFixed(2)}.
                - Use the following detailed list of bills in the body of the email:
                ${billDetails}
                
                The email must include:
                1. A professional subject line indicating 'Urgent Notice of Overdue Payment'.
                2. A polite greeting.
                3. A clear statement of the total outstanding amount.
                4. The detailed list of bills (use Markdown lists/formatting).
                5. A firm request for immediate payment and a call to action.
                6. A standard professional closing ('تحياتي', 'قسم الحسابات').
                
                Structure the output to be copied directly as an email body.`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "You are an expert in drafting formal B2B debt collection emails. The response must be a single block of Arabic text suitable for an email body." }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("فشل في الاتصال بـ Gemini.");
                
                const result = await response.json();
                const noticeText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (noticeText) {
                    renderAiOutput('مسودة إشعار المطالبة بالدفع', noticeText);
                    displayMessage('تم صياغة الإشعار بنجاح.', 'success');
                } else {
                    throw new Error('لم يتم استلام نص الإشعار.');
                }


            } catch (error) {
                console.error("AI Notice Error:", error);
                displayMessage(`حدث خطأ أثناء صياغة الإشعار: ${error.message}`, 'error');
            } finally {
                noticeLoading.classList.add('hidden');
            }
        }
        
        /**
         * Renders the AI-generated text output.
         * @param {string} title - Title for the output box.
         * @param {string} content - The generated text content.
         */
        function renderAiOutput(title, content) {
            aiOutputTitle.textContent = title;
            aiOutputContent.textContent = content;
            aiOutputDiv.classList.remove('hidden');
            copyAiOutputBtn.classList.remove('hidden');
        }


        window.onload = () => {
             // Optional: Initial message or setup on load
        };
    </script>
</body>
</html>
